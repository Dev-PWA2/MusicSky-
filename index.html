<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MusicSky</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(120deg,#e0e7ff,#fffaf0 90%);
            min-height: 100vh;
        }
        .hidden { display: none; }
        .panel { margin-top: 40px;}
        .music-list audio { width: 100%; }
        .music-item { border-bottom: 1px solid #eee; padding: 10px 0;}
        .pointer { cursor:pointer; }
        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #4e54c8;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex align-items-center mb-4">
        <div class="logo me-3">MusicSky</div>
        <span class="text-muted">– Tu nube de música personal</span>
    </div>
    <!-- AUTENTICACIÓN -->
    <div id="auth-section">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <ul class="nav nav-tabs mb-3" id="authTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-panel" type="button" role="tab">Registrarse</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-panel" type="button" role="tab">Iniciar Sesión</button>
                  </li>
                </ul>
                <div class="tab-content" id="authTabsContent">
                    <!-- Registro -->
                    <div class="tab-pane fade show active" id="register-panel" role="tabpanel">
                        <form id="registerForm" novalidate>
                            <div class="mb-3">
                                <label>Nombre completo</label>
                                <input type="text" class="form-control" id="regFullName" required>
                            </div>
                            <div class="mb-3">
                                <label>Correo Gmail</label>
                                <input type="email" class="form-control" id="regEmail" required pattern=".+@gmail\.com$">
                            </div>
                            <div class="mb-3">
                                <label>Contraseña</label>
                                <input type="password" class="form-control" id="regPassword" required>
                                <div class="form-text">
                                    12 caracteres: 6 letras iniciales (la primera mayúscula), 4 números, 2 símbolos (@ # &).<br>
                                    Dependiendo del rol, las letras iniciales deben ser: <b>Admini</b> (Administrador) o <b>Usuari</b> (Usuario).
                                </div>
                            </div>
                            <div class="mb-3">
                                <label>Rol</label>
                                <select class="form-select" id="regRole" required>
                                    <option value="">Selecciona tu rol</option>
                                    <option value="Administrador">Administrador</option>
                                    <option value="Usuario">Usuario</option>
                                    <option value="Invitado">Invitado</option>
                                </select>
                            </div>
                            <div class="mb-3 hidden" id="guestReasonDiv">
                                <label>Razón de acceso (Obligatorio para invitados)</label>
                                <textarea class="form-control" id="guestReason" rows="2"></textarea>
                            </div>
                            <div class="mb-3 hidden" id="guestConfirmDiv">
                                <label>Reingresa tu nombre completo</label>
                                <input type="text" class="form-control" id="guestConfirmName">
                            </div>
                            <div class="mb-2 text-danger" id="regError"></div>
                            <button class="btn btn-primary w-100" type="submit">Registrarse</button>
                        </form>
                    </div>
                    <!-- Login -->
                    <div class="tab-pane fade" id="login-panel" role="tabpanel">
                        <form id="loginForm" novalidate>
                            <div class="mb-3">
                                <label>Correo Gmail</label>
                                <input type="email" class="form-control" id="loginEmail" required pattern=".+@gmail\.com$">
                            </div>
                            <div class="mb-3">
                                <label>Contraseña</label>
                                <input type="password" class="form-control" id="loginPassword" required>
                            </div>
                            <div class="mb-2 text-danger" id="loginError"></div>
                            <button class="btn btn-success w-100" type="submit">Iniciar Sesión</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- PANEL PRINCIPAL -->
    <div id="main-panel" class="panel hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span><b>Bienvenido/a, </b><span id="userNameSpan"></span> (<span id="userRoleSpan"></span>)</span>
            </div>
            <div>
                <button class="btn btn-outline-danger btn-sm" id="logoutBtn">Cerrar sesión</button>
            </div>
        </div>
        <ul class="nav nav-pills mb-3" id="mainTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="tab-musics" data-bs-toggle="pill" data-bs-target="#panel-musics" type="button" role="tab">Músicas</button></li>
            <li class="nav-item"><button class="nav-link" id="tab-upload" data-bs-toggle="pill" data-bs-target="#panel-upload" type="button" role="tab">Subir Música</button></li>
            <li class="nav-item"><button class="nav-link" id="tab-informate" data-bs-toggle="pill" data-bs-target="#panel-informate" type="button" role="tab">Infórmate</button></li>
            <li class="nav-item" id="tab-users-li"><button class="nav-link" id="tab-users" data-bs-toggle="pill" data-bs-target="#panel-users" type="button" role="tab">Gestión de usuarios</button></li>
        </ul>
        <div class="tab-content">
            <!-- Músicas -->
            <div class="tab-pane fade show active" id="panel-musics" role="tabpanel">
                <h5>Músicas subidas</h5>
                <div id="musicList" class="music-list"></div>
            </div>
            <!-- Subir Música -->
            <div class="tab-pane fade" id="panel-upload" role="tabpanel">
                <div class="card p-3">
                    <h6>Subir nueva música (MP3)</h6>
                    <form id="uploadForm">
                        <div class="mb-2">
                            <input type="file" accept=".mp3,audio/mp3" class="form-control" id="musicFile" required>
                        </div>
                        <div class="mb-2">
                            <label>Título de la música</label>
                            <input type="text" class="form-control" id="musicTitle" required>
                        </div>
                        <div class="mb-2">
                            <label>Detalles (opcional)</label>
                            <textarea class="form-control" id="musicDetails"></textarea>
                        </div>
                        <div class="mb-2 text-danger" id="uploadError"></div>
                        <button class="btn btn-primary" type="submit">Subir Música</button>
                    </form>
                </div>
            </div>
            <!-- Infórmate -->
            <div class="tab-pane fade" id="panel-informate" role="tabpanel">
                <div class="card p-3">
                    <h5>¿Qué es MusicSky?</h5>
                    <p>
                        MusicSky es una aplicación web interactiva para almacenar y compartir tus músicas favoritas en la nube. Permite subir, escuchar y descargar archivos MP3 de forma segura y organizada mediante autenticación de usuarios y control de roles. 
                    </p>
                    <h6>¿Cómo se utiliza?</h6>
                    <ul>
                        <li>Regístrate seleccionando tu rol y sigue las instrucciones.</li>
                        <li>Inicia sesión y accede al panel principal.</li>
                        <li>Sube músicas en formato MP3 desde tu dispositivo.</li>
                        <li>Escucha, descarga y gestiona tus músicas según tu rol.</li>
                    </ul>
                    <h6>Sobre el desarrollador</h6>
                    <ul>
                        <li><b>Nombre completo:</b> Tarciano ENZEMA NCHAMA</li>
                        <li><b>Formación académica:</b> Finalista universitario de la UNGE</li>
                        <li><b>Facultad:</b> Ciencias económicas gestión y administración</li>
                        <li><b>Departamento:</b> Informática de gestión empresarial</li>
                        <li><b>Contacto:</b> enzemajr@gmail.com</li>
                        <li><b>Fecha final del desarrollo:</b> 01/07/2025</li>
                    </ul>
                </div>
            </div>
            <!-- Gestión de usuarios (solo Admin) -->
            <div class="tab-pane fade" id="panel-users" role="tabpanel">
                <h5>Gestión de usuarios</h5>
                <div id="usersList"></div>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ========== IndexedDB SETUP ==========
let db;
const DB_NAME = 'MusicSkyDB', DB_VERSION = 1;

// Abrir/crear la base de datos
function openDB(callback) {
    const request = window.indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = function(e) {
        db = e.target.result;
        if (!db.objectStoreNames.contains('users')) {
            const userStore = db.createObjectStore('users', { keyPath: 'email' });
            userStore.createIndex('role', 'role', { unique: false });
            userStore.createIndex('blocked', 'blocked', { unique: false });
        }
        if (!db.objectStoreNames.contains('musics')) {
            const musicStore = db.createObjectStore('musics', { keyPath: 'id', autoIncrement: true });
            musicStore.createIndex('uploader', 'uploader', { unique: false });
        }
    };
    request.onsuccess = function(e) {
        db = e.target.result;
        if (callback) callback();
    };
    request.onerror = function(e) {
        alert('Error al abrir la base de datos.');
    };
}

function getUser(email, cb) {
    const tx = db.transaction('users', 'readonly').objectStore('users').get(email);
    tx.onsuccess = e => cb(e.target.result);
    tx.onerror = () => cb(null);
}

function putUser(user, cb) {
    const tx = db.transaction('users', 'readwrite').objectStore('users').put(user);
    tx.onsuccess = () => cb(true);
    tx.onerror = () => cb(false);
}

function getAllUsers(cb) {
    const users = [];
    const store = db.transaction('users', 'readonly').objectStore('users');
    store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
            users.push(cursor.value);
            cursor.continue();
        } else cb(users);
    };
}

function deleteUser(email, cb) {
    const tx = db.transaction('users', 'readwrite').objectStore('users').delete(email);
    tx.onsuccess = () => cb(true);
    tx.onerror = () => cb(false);
}

function getAllMusics(cb) {
    const musics = [];
    const store = db.transaction('musics', 'readonly').objectStore('musics');
    store.openCursor().onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
            musics.push(cursor.value);
            cursor.continue();
        } else cb(musics);
    };
}

function putMusic(music, cb) {
    const tx = db.transaction('musics', 'readwrite').objectStore('musics').put(music);
    tx.onsuccess = () => cb(true);
    tx.onerror = () => cb(false);
}

function deleteMusic(id, cb) {
    const tx = db.transaction('musics', 'readwrite').objectStore('musics').delete(id);
    tx.onsuccess = () => cb(true);
    tx.onerror = () => cb(false);
}

// ========== SESIÓN ==========
let currentUser = null;

// ========== VALIDACIÓN ==========
function validateEmail(email) {
    return /^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(email);
}
function validatePassword(pass, role) {
    // 12 caracteres, 6 letras iniciales, 1ª mayúscula, 4 números, 2 símbolos permitidos
    let rolePrefix = role === 'Administrador' ? 'Admini' : role === 'Usuario' ? 'Usuari' : '';
    if (role === 'Invitado') return pass.length === 12 && /^[A-Z][a-z]{5}\d{4}[@#&]{2}$/.test(pass);
    let regex = new RegExp(`^${rolePrefix}[a-zA-Z]{0}\\d{4}[@#&]{2}$`);
    if (!pass.startsWith(rolePrefix)) return false;
    // Resto: 6 letras ya comprobadas, + 4 números + 2 símbolos
    let rest = pass.slice(rolePrefix.length);
    return rest.length === 6 && /^\d{4}[@#&]{2}$/.test(rest) && pass.length === 12;
}

// ========== AUTENTICACIÓN ==========
function showPanel(panel) {
    document.getElementById('auth-section').classList.toggle('hidden', panel !== 'auth');
    document.getElementById('main-panel').classList.toggle('hidden', panel !== 'main');
}
function clearRegisterForm() {
    document.getElementById('registerForm').reset();
    document.getElementById('regError').innerText = '';
    document.getElementById('guestReasonDiv').classList.add('hidden');
    document.getElementById('guestConfirmDiv').classList.add('hidden');
}
function clearLoginForm() {
    document.getElementById('loginForm').reset();
    document.getElementById('loginError').innerText = '';
}

// ========== ENVÍO DE EMAIL (Simulado) ==========
function sendEmail(to, subject, body) {
    // En apps reales usaría backend y nodemailer/emailjs/sendgrid/etc.
    // Aquí lo simulamos con un alert. En producción usar fetch() a tu API.
    console.log(`Email enviado a ${to}:\n${subject}\n${body}`);
}

// ========== REGISTRO ==========
document.getElementById('regRole').addEventListener('change', function() {
    let v = this.value;
    document.getElementById('guestReasonDiv').classList.toggle('hidden', v !== 'Invitado');
    document.getElementById('guestConfirmDiv').classList.toggle('hidden', v !== 'Invitado');
});
document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    let fullName = document.getElementById('regFullName').value.trim();
    let email = document.getElementById('regEmail').value.trim().toLowerCase();
    let password = document.getElementById('regPassword').value;
    let role = document.getElementById('regRole').value;
    let errorDiv = document.getElementById('regError');
    let guestReason = document.getElementById('guestReason').value.trim();
    let guestConfirm = document.getElementById('guestConfirmName').value.trim();

    // Validaciones
    if (!fullName || !email || !password || !role) {
        errorDiv.innerText = 'Todos los campos son obligatorios.';
        return;
    }
    if (!validateEmail(email)) {
        errorDiv.innerText = 'El correo debe ser Gmail válido.';
        return;
    }
    if (!validatePassword(password, role)) {
        errorDiv.innerText = 'La contraseña no cumple los requisitos para el rol seleccionado.';
        return;
    }
    if (role === 'Invitado') {
        if (!guestReason) {
            errorDiv.innerText = 'Debes especificar la razón de acceso.';
            return;
        }
        if (!guestConfirm) {
            errorDiv.innerText = 'Debes reingresar tu nombre completo.';
            return;
        }
        if (fullName !== guestConfirm) {
            // Simular envío de email con info, fecha y hora
            let now = new Date();
            sendEmail(
                'enzemajr@gmail.com',
                'Intento de acceso denegado (Invitado)',
                `Nombre ingresado para confirmar no coincide.\nNombre registro: ${fullName}\nNombre reingresado: ${guestConfirm}\nRazón: ${guestReason}\nEmail: ${email}\nFecha y hora: ${now.toLocaleString()}`
            );
            errorDiv.innerText = 'Nombre no coincide. Acceso denegado. Intenta de nuevo.';
            setTimeout(clearRegisterForm, 2500);
            return;
        }
    }

    // Verificar si ya existe
    getUser(email, function(user) {
        if (user) {
            errorDiv.innerText = 'Ya existe una cuenta con este correo.';
            return;
        }
        let userObj = {
            fullName, email, password, role,
            blocked: false,
            date: new Date().toLocaleString(),
            guestReason: role === 'Invitado' ? guestReason : null
        };
        putUser(userObj, function(success) {
            if (success) {
                // Simular email de registro a admin
                sendEmail(
                    'enzemajr@gmail.com',
                    'Nuevo registro en MusicSky',
                    `Nombre: ${fullName}\nEmail: ${email}\nRol: ${role}\nRazón: ${userObj.guestReason || 'N/A'}\nFecha registro: ${userObj.date}`
                );
                clearRegisterForm();
                // Mostrar panel de login automáticamente
                let tab = new bootstrap.Tab(document.querySelector('#login-tab'));
                tab.show();
                document.getElementById('loginEmail').value = email;
                document.getElementById('loginPassword').value = password;
                errorDiv.innerText = '';
            } else {
                errorDiv.innerText = 'Error al registrar. Intenta de nuevo.';
            }
        });
    });
});

// ========== LOGIN ==========
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    let email = document.getElementById('loginEmail').value.trim().toLowerCase();
    let password = document.getElementById('loginPassword').value;
    let errorDiv = document.getElementById('loginError');
    if (!email || !password) {
        errorDiv.innerText = 'Rellena todos los campos.';
        return;
    }
    getUser(email, function(user) {
        if (!user || user.password !== password) {
            errorDiv.innerText = 'Email o contraseña incorrectos.';
            return;
        }
        if (user.blocked) {
            errorDiv.innerText = 'Usuario bloqueado. Contacte con el administrador.';
            return;
        }
        // Login correcto
        currentUser = user;
        document.getElementById('userNameSpan').innerText = user.fullName;
        document.getElementById('userRoleSpan').innerText = user.role;
        showPanel('main');
        showMainByRole();
        loadMusics();
        if (currentUser.role === "Administrador") loadUsers();
    });
});

// ========== LOGOUT ==========
document.getElementById('logoutBtn').addEventListener('click', function() {
    currentUser = null;
    showPanel('auth');
    clearLoginForm();
});

// ========== PANELES POR ROL ==========
function showMainByRole() {
    // Mostrar/ocultar pestañas según rol
    let isAdmin = currentUser && currentUser.role === 'Administrador';
    document.getElementById('tab-users-li').style.display = isAdmin ? 'inline-block' : 'none';
    // Subir música: solo admin y usuario
    document.getElementById('tab-upload').parentElement.style.display = 
        (currentUser.role === 'Administrador' || currentUser.role === 'Usuario') ? 'inline-block' : 'none';
}

// ========== LISTADO DE MÚSICAS ==========
function loadMusics() {
    getAllMusics(function(musics) {
        musics.sort((a,b)=>new Date(b.date)-new Date(a.date));
        let html = '';
        if (!musics.length) html = '<p>No hay músicas subidas aún.</p>';
        else musics.forEach(music => {
            html += `<div class="music-item row align-items-center">
                <div class="col-md-4">
                    <b>${music.title}</b> <small class="text-muted">(${music.details || 'Sin detalles'})</small>
                    <div><small>Subido por: ${music.uploaderName} (${music.uploader})</small></div>
                    <div><small>Fecha: ${music.date}</small></div>
                </div>
                <div class="col-md-4">
                    <audio controls src="${music.url}"></audio>
                </div>
                <div class="col-md-4 text-end">
                    <a download="${music.title}.mp3" href="${music.url}" class="btn btn-sm btn-outline-primary me-1">Descargar</a>
                    ${canEditMusic(music) ? `
                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="editMusic(${music.id})">Editar</button>
                    ` : ''}
                    ${canDeleteMusic(music) ? `
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMusicUI(${music.id})">Eliminar</button>
                    ` : ''}
                </div>
            </div>`;
        });
        document.getElementById('musicList').innerHTML = html;
    });
}
function canEditMusic(music) {
    if (!currentUser) return false;
    return currentUser.role === 'Administrador' || 
        (currentUser.role === 'Usuario' && music.uploader === currentUser.email);
}
function canDeleteMusic(music) {
    if (!currentUser) return false;
    return currentUser.role === 'Administrador' || 
        (currentUser.role === 'Usuario' && music.uploader === currentUser.email);
}
window.editMusic = function(id) {
    // Simple edición de detalles
    getAllMusics(function(musics){
        let music = musics.find(m=>m.id===id);
        if (!music) return;
        let details = prompt('Editar detalles de la música:', music.details||'');
        if (details !== null) {
            music.details = details;
            putMusic(music, function(){
                loadMusics();
            });
        }
    });
};
window.deleteMusicUI = function(id) {
    if (!confirm('¿Seguro que deseas eliminar esta música?')) return;
    deleteMusic(id, function(){
        loadMusics();
    });
};

// ========== SUBIR MÚSICA ==========
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    let fileInput = document.getElementById('musicFile');
    let title = document.getElementById('musicTitle').value.trim();
    let details = document.getElementById('musicDetails').value.trim();
    let errorDiv = document.getElementById('uploadError');
    let file = fileInput.files[0];
    if (!file || !/^audio\/mp3|audio\/mpeg|application\/octet-stream$/.test(file.type) && !file.name.endsWith('.mp3')) {
        errorDiv.innerText = 'Selecciona un archivo MP3 válido.';
        return;
    }
    if (!title) {
        errorDiv.innerText = 'Introduce un título para la música.';
        return;
    }
    let reader = new FileReader();
    reader.onload = function(ev) {
        let music = {
            title,
            details,
            uploader: currentUser.email,
            uploaderName: currentUser.fullName,
            date: new Date().toLocaleString(),
            url: ev.target.result // base64
        };
        putMusic(music, function(ok){
            if (ok) {
                errorDiv.innerText = '';
                fileInput.value = '';
                document.getElementById('musicTitle').value = '';
                document.getElementById('musicDetails').value = '';
                loadMusics();
            } else {
                errorDiv.innerText = 'Error al subir música.';
            }
        });
    };
    reader.readAsDataURL(file);
});

// ========== GESTIÓN DE USUARIOS (ADMIN) ==========
function loadUsers() {
    getAllUsers(function(users) {
        let html = `<table class="table table-bordered table-sm">
            <thead><tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr></thead><tbody>`;
        users.forEach(user => {
            html += `<tr>
                <td>${user.fullName}</td>
                <td>${user.email}</td>
                <td>${user.role}</td>
                <td>${user.blocked ? '<span class="text-danger">Bloqueado</span>' : 'Activo'}</td>
                <td>
                    <button class="btn btn-sm btn-${user.blocked ? 'success' : 'warning'} me-1" onclick="toggleBlock('${user.email}',${!user.blocked})">
                        ${user.blocked ? 'Desbloquear' : 'Bloquear'}
                    </button>
                    <button class="btn btn-sm btn-danger me-1" onclick="deleteUserUI('${user.email}')">Eliminar</button>
                    <button class="btn btn-sm btn-secondary" onclick="editUserUI('${user.email}')">Editar</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('usersList').innerHTML = html;
    });
}
window.toggleBlock = function(email, block) {
    getUser(email, function(user){
        if (!user) return;
        user.blocked = block;
        putUser(user, function(){
            loadUsers();
        });
    });
};
window.deleteUserUI = function(email) {
    if (!confirm('¿Seguro que deseas eliminar este usuario?')) return;
    deleteUser(email, function(){
        loadUsers();
    });
};
window.editUserUI = function(email) {
    getUser(email, function(user){
        if (!user) return;
        let newName = prompt('Editar nombre completo:', user.fullName);
        if (newName && newName.trim()) {
            user.fullName = newName.trim();
            putUser(user, function(){
                loadUsers();
            });
        }
    });
};

// ========== INICIO ==========
window.onload = function() {
    openDB(function() {
        showPanel('auth');
    });
    // Mostrar panel principal si ya hay sesión (no persistente para demo)
};
</script>
</body>
</html>
